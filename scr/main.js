// ================================================================================= // main.js (ULTIMATE FINAL & ROBUST VERSION 8.1 - FULL CODE) - FIXED & COMPLETE // เวอร์ชันสมบูรณ์แบบที่รวมทุกฟังก์ชันการทำงานขั้นสูงไว้ในที่เดียว // รวมการแก้ไขที่จำเป็น (no minify, no removal) เพื่อให้ทำงานได้เต็มรูปแบบ // ================================================================================= (function() { 'use strict'; class SidelineWebApp { // --- 1. CONFIGURATION & INITIALIZATION --- constructor() { this.CONFIG = { SUPABASE_URL: 'https://hgzbgpbmymoiwjpaypvl.supabase.co', SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnemJncGJteW1vaXdqcGF5cHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxMDUyMDYsImV4cCI6MjA2MjY4MTIwNn0.dIzyENU-kpVD97WyhJVZF9owDVotbl1wcYgPTt9JL_8', STORAGE_BUCKET: 'profile-images', MAX_FEATURED_PROFILES: 9, PROFILES_PER_PROVINCE_ON_INDEX: 8, DEBOUNCE_DELAY: 350, FAIL_SAFE_TIMEOUT: 5000, PLACEHOLDER_IMAGE: '/images/placeholder-profile.webp' }; this.dom = {}; this.state = { supabase: null, gsap: null, ScrollTrigger: null, allProfiles: [], provincesMap: new Map(), filteredProfiles: [], lastFocusedElement: null, isMenuOpen: false, isLightboxOpen: false, isFetching: false, isAgeVerified: sessionStorage.getItem('ageVerified') === 'true', currentLightboxProfileId: null, currentPage: 'home' }; this._handlers = {}; this.initializeSafely(); } // --- 2. ROBUST INITIALIZATION FLOW (with Safety Nets) --- initializeSafely() { const preloader = document.getElementById('preloader'); const body = document.body; const failSafeTimeout = setTimeout(() => { console.warn("Initialization took too long. Forcing content display."); this.showApp(preloader, body); }, this.CONFIG.FAIL_SAFE_TIMEOUT); const startApp = async () => { try {

await this.init(preloader, body, failSafeTimeout); //ส่งตัวแปรเข้าไปใน init
console.log("✅ App initialized successfully.");
} catch (error) { console.error("❌ FATAL: App initialization failed:", error); this.showApp(preloader, body, failSafeTimeout); this.showContentState('error'); } }; if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', startApp); } else { startApp(); } } showApp(preloader, body, timeoutId = null) { if (timeoutId) clearTimeout(timeoutId); if (preloader) preloader.classList.add('loaded'); if (body) body.classList.add('ready'); } 

async init(preloader, body, failSafeTimeout) { // <-- รับพารามิเตอร์
    this.bindHandlers();
    this.cacheDOMElements();
    this.state.currentPage = (this.dom.body && this.dom.body.dataset && this.dom.body.dataset.page) || 'home';

    // *** จุดที่แก้ไข ***
    // ซ่อน Preloader ทันทีเพื่อให้ผู้ใช้เห็น Modal ยืนยันอายุ
    this.showApp(preloader, body, failSafeTimeout);

    this.initImmediateUI();
    await this.loadSupabaseClient();
    await this.initAgeVerification(); // <-- ตอนนี้สามารถรอได้แล้ว เพราะผู้ใช้เห็นปุ่มแล้ว
    const fetchDataSuccess = await this.fetchData();

if (fetchDataSuccess) { this.initDataDependentFeatures(); } else { throw new Error("Failed to fetch initial data. Check Supabase connection or table names."); } this.initDeferredTasks(); } initImmediateUI() { if (this.dom.yearSpan) this.dom.yearSpan.textContent = new Date().getFullYear(); this.initThemeToggle(); this.initMobileMenu(); this.initHeaderScrollEffect(); this.initBackToTop(); // --- additional safe event bindings (must be after cacheDOMElements) // menu toggle if (this.dom.menuToggle) this.dom.menuToggle.addEventListener('click', this.handleMobileMenuInteraction); if (this.dom.closeSidebarBtn) this.dom.closeSidebarBtn.addEventListener('click', () => this.closeMobileMenu()); if (this.dom.backdrop) this.dom.backdrop.addEventListener('click', () => this.closeMobileMenu()); // global keydown document.addEventListener('keydown', this.handleGlobalKeydown); // close lightbox button if (this.dom.closeLightboxBtn) this.dom.closeLightboxBtn.addEventListener('click', () => this.closeLightbox()); // reset filters button (if present) if (this.dom.resetFiltersBtn) this.dom.resetFiltersBtn.addEventListener('click', (e) => { e.preventDefault(); if (this.dom.filterForm) { this.dom.filterForm.reset(); this.applyFiltersFromForm(); } }); // ensure focus/aria for sidebar initially if (this.dom.sidebar) this.dom.sidebar.setAttribute('aria-hidden', String(!this.state.isMenuOpen)); } initDataDependentFeatures() { this.initFilters(); this.initLightbox(); this.applyFiltersFromURL(); this.generateFullSchema(); } initDeferredTasks() { if ('requestIdleCallback' in window) { requestIdleCallback(() => this.loadAnimationScripts(), { timeout: 2000 }); } else { setTimeout(() => this.loadAnimationScripts(), 1500); } } bindHandlers() { const handlers = [ 'handleGlobalKeydown', 'handleViewMore', 'handleFilterChange', 'handleFilterReset', 'handleLightboxInteraction', 'handleMobileMenuInteraction' ]; handlers.forEach(h => { if(typeof this[h] === 'function') this[h] = this[h].bind(this); }); } // ----------------- SAFER cacheDOMElements (fixed) ----------------- cacheDOMElements() { const selectors = { body: document.body, preloader: '#preloader', yearSpan: '#currentYearDynamic', pageHeader: '#page-header', featuredSection: '#featured-profiles', featuredContainer: '#featured-profiles-container', profilesContentArea: '#profiles-display-area', filterForm: '#search-form', filterKeyword: '#search-keyword', filterProvince: '#search-province', filterAvailability: '#search-availability', filterFeatured: '#search-featured', resetFiltersBtn: '#reset-search-btn', menuToggle: '#menu-toggle', sidebar: '#sidebar', closeSidebarBtn: '#close-sidebar-btn', backdrop: '#menu-backdrop', ageVerificationOverlay: '#age-verification-overlay', confirmAgeButton: '#confirmAgeButton', cancelAgeButton: '#cancelAgeButton', lightbox: '#lightbox', lightboxContentWrapper: '#lightbox-content-wrapper-el', closeLightboxBtn: '#closeLightboxBtn', lightboxHeaderTitle: '#lightbox-header-title', lightboxHeroImage: '#lightboxHeroImage', lightboxSpinner: '#lightbox-spinner', lightboxImageError: '#lightbox-image-error', lightboxProfileName: '#lightbox-profile-name-main', lightboxQuote: '#lightboxQuote', lightboxTags: '#lightboxTags', lightboxDetails: '#lightboxDetailsCompact', lightboxDescription: '#lightboxDescriptionVal', lightboxLineLink: '#lightboxLineLink', lightboxLineLinkText: '#lightboxLineLinkText', lightboxPrevBtn: '#lightbox-prev-btn', lightboxNextBtn: '#lightbox-next-btn', lightboxThumbnailStrip: '#lightboxThumbnailStrip', backToTopBtn: '#back-to-top', noResultsMessage: '#no-results-message', fetchErrorMessage: '#fetch-error-message' }; for (const key in selectors) { try { const sel = selectors[key]; if (typeof sel === 'string') { this.dom[key] = document.querySelector(sel); } else if (sel instanceof Element || sel instanceof Node) { this.dom[key] = sel; } else { this.dom[key] = null; } } catch (err) { console.warn(`cacheDOMElements: failed to query "${key}"`, err); this.dom[key] = null; } } } // --- 3. DYNAMIC SCRIPT & DATA LOADING --- async loadSupabaseClient() { if (this.state.supabase) return; try { const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'); this.state.supabase = createClient(this.CONFIG.SUPABASE_URL, this.CONFIG.SUPABASE_KEY); } catch (error) { console.error('CRITICAL: Supabase client failed to load.', error); throw error; } } async loadAnimationScripts() { if (this.state.gsap) return; try { const [gsapModule, scrollTriggerModule] = await Promise.all([ import("https://cdn.jsdelivr.net/npm/gsap@3.12.5/+esm"), import("https://cdn.jsdelivr.net/npm/gsap@3.12.5/ScrollTrigger/+esm") ]); this.state.gsap = gsapModule.gsap; this.state.ScrollTrigger = scrollTriggerModule.ScrollTrigger; this.state.gsap.registerPlugin(this.state.ScrollTrigger); this.initScrollAnimations(); this.init3DCardEffect(); } catch (error) { console.warn('Animation scripts (GSAP) failed to load. Animations will be disabled.', error); } } async fetchData() { if (this.state.isFetching) return false; this.state.isFetching = true; try { const [profilesRes, provincesRes] = await Promise.all([ this.state.supabase.from('profiles').select('*').order('isfeatured', { ascending: false }).order('lastUpdated', { ascending: false }), this.state.supabase.from('provinces').select('*').order('nameThai', { ascending: true }) ]); if (profilesRes.error) throw profilesRes.error; if (provincesRes.error) throw provincesRes.error; this.state.provincesMap = new Map((provincesRes.data || []).map(p => [p.key, p.nameThai])); this.state.allProfiles = (profilesRes.data || []).map(p => this.processProfileData(p)); this.populateProvinceFilter(); // initially, filteredProfiles equals allProfiles this.state.filteredProfiles = this.state.allProfiles.slice(); return true; } catch (error) { console.error('CRITICAL: Supabase fetch error:', error && error.message ? error.message : error); this.showContentState('error'); return false; } finally { this.state.isFetching = false; } } // --- วางทับฟังก์ชัน processProfileData() เดิมในไฟล์ main.js (แก้ไขเล็กน้อยเพื่อความปลอดภัย) --- processProfileData(p) { const allImagePaths = [p.imagePath, ...(p.galleryPaths || [])].filter(Boolean); const images = allImagePaths.map(path => { try { const publicUrl = this.state.supabase.storage.from(this.CONFIG.STORAGE_BUCKET).getPublicUrl(path).data.publicUrl; return publicUrl; } catch (e) { console.warn('processProfileData: failed to get public url for', path, e); return this.CONFIG.PLACEHOLDER_IMAGE; } }); if (images.length === 0) images.push(this.CONFIG.PLACEHOLDER_IMAGE); // --- บรรทัดนี้ได้รับการแก้ไขแล้ว --- const styleTagsString = p.styleTags ? (Array.isArray(p.styleTags) ? p.styleTags.join(' ') : String(p.styleTags)) : ''; return { ...p, images, searchable: `${p.name || ''} ${styleTagsString} ${this.state.provincesMap.get(p.provinceKey) || ''}`.toLowerCase(), altText: p.altText || `โปรไฟล์ไซด์ไลน์ ${p.name} จังหวัด ${this.state.provincesMap.get(p.provinceKey) || ''}` }; } // safer id lookup (handles string/number) getProfileById(id) { return this.state.allProfiles.find(p => String(p.id) === String(id)); } // --- 4. ADVANCED RENDERING LOGIC --- render() { if (!this.dom.profilesContentArea || !this.dom.featuredSection || !this.dom.featuredContainer) { console.warn("Render Aborted: Core display elements are not in the DOM."); return; } // 1. Render Featured Profiles const featuredProfiles = (this.state.filteredProfiles || []) .filter(p => p.isfeatured) .slice(0, this.CONFIG.MAX_FEATURED_PROFILES); if (featuredProfiles.length > 0) { const fragment = document.createDocumentFragment(); featuredProfiles.forEach(p => fragment.appendChild(this.createCardHTML(p, true))); this.dom.featuredContainer.innerHTML = ''; this.dom.featuredContainer.appendChild(fragment); this.dom.featuredSection.classList.remove('hidden'); } else { this.dom.featuredSection.classList.add('hidden'); } // 2. Render Regular Profiles const regularProfiles = (this.state.filteredProfiles || []).filter(p => !p.isfeatured); this.dom.profilesContentArea.innerHTML = ''; if (!this.state.filteredProfiles || this.state.filteredProfiles.length === 0) { this.showContentState('empty'); } else { this.showContentState('ready'); const mainFragment = document.createDocumentFragment(); const byProvince = regularProfiles.reduce((acc, p) => { (acc[p.provinceKey] = acc[p.provinceKey] || []).push(p); return acc; }, {}); const provinceOrder = [...this.state.provincesMap.keys()].filter(key => key in byProvince); provinceOrder.forEach(key => mainFragment.appendChild(this.createSectionHTML(key, this.state.provincesMap.get(key) || 'ไม่ระบุ', byProvince[key]))); this.dom.profilesContentArea.appendChild(mainFragment); } // re-bind lightbox triggers (cards inserted dynamically) // using event delegation is already set up on body in initLightbox() this.initScrollAnimations(); } showContentState(state) { const { noResultsMessage, fetchErrorMessage } = this.dom; if (noResultsMessage) noResultsMessage.classList.add('hidden'); if (fetchErrorMessage) fetchErrorMessage.classList.add('hidden'); if (state === 'empty' && noResultsMessage) noResultsMessage.classList.remove('hidden'); if (state === 'error' && fetchErrorMessage) fetchErrorMessage.classList.remove('hidden'); } createCardHTML(profile, isEager = false) { const card = document.createElement('div'); card.className = 'profile-card-new group cursor-pointer'; card.dataset.profileId = profile.id; card.setAttribute('role', 'button'); card.tabIndex = 0; const mainImage = profile.images[0] || this.CONFIG.PLACEHOLDER_IMAGE; const img = document.createElement('img'); img.src = `${mainImage}?width=600&quality=80`; img.srcset = `${mainImage}?width=400&quality=80 400w, ${mainImage}?width=600&quality=80 600w`; img.sizes = "(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw"; img.alt = profile.altText; img.className = "card-image"; img.decoding = "async"; img.width = 400; img.height = 533; img.loading = isEager ? 'eager' : 'lazy'; if (isEager) img.setAttribute('fetchpriority', 'high'); img.onerror = (e) => { e.target.onerror = null; e.target.src = this.CONFIG.PLACEHOLDER_IMAGE; e.target.srcset = ''; }; const availabilityText = profile.availability || "สอบถามคิว"; let availabilityClass = 'bg-yellow-200 text-yellow-800'; if (availabilityText && availabilityText.includes('ว่าง')) availabilityClass = 'bg-green-200 text-green-800'; if (availabilityText && availabilityText.includes('ไม่ว่าง')) availabilityClass = 'bg-red-200 text-red-800'; card.innerHTML = ` <div class="card-overlay"> <h3 class="text-xl lg:text-2xl font-bold truncate">${profile.name}</h3> <p class="text-sm flex items-center gap-1.5"><i class="fas fa-map-marker-alt text-xs"></i> ${this.state.provincesMap.get(profile.provinceKey) || 'ไม่ระบุ'}</p> </div> <div class="absolute top-2 right-2 flex flex-col items-end gap-1.5 z-10"> <span class="${availabilityClass} text-xs font-semibold px-2.5 py-1 rounded-full shadow-lg">${availabilityText}</span> ${profile.isfeatured ? `<span class="bg-yellow-400 text-black text-xs font-semibold px-2.5 py-1 rounded-full flex items-center gap-1 shadow-lg"><i class="fas fa-star w-3 h-3"></i>แนะนำ</span>` : ''} </div>`; card.prepend(img); return card; } createSectionHTML(id, title, profiles) { const section = document.createElement('section'); section.className = 'province-section'; const initialLimit = this.CONFIG.PROFILES_PER_PROVINCE_ON_INDEX; const profilesToShow = (profiles || []).slice(0, initialLimit); const gridContainer = document.createElement('div'); gridContainer.className = 'profile-grid'; gridContainer.dataset.provinceGrid = id; profilesToShow.forEach(p => gridContainer.appendChild(this.createCardHTML(p))); section.innerHTML = ` <div class="province-section-header"> <h3 id="province-heading-${id}" class="text-2xl font-bold">${title}</h3> <a href="/profiles.html?province=${id}" class="text-sm font-semibold text-primary hover:underline">ดูทั้งหมด (${(profiles||[]).length})</a> </div>`; section.appendChild(gridContainer); if ((profiles || []).length > initialLimit) { const viewMoreBtn = document.createElement('button'); viewMoreBtn.className = 'view-more-btn'; viewMoreBtn.dataset.province = id; viewMoreBtn.textContent = `ดูเพิ่มเติม (${profiles.length - initialLimit})`; viewMoreBtn.addEventListener('click', this.handleViewMore); const btnContainer = document.createElement('div'); btnContainer.className = 'text-center mt-8'; btnContainer.appendChild(viewMoreBtn); section.appendChild(btnContainer); } return section; } populateProvinceFilter() { if (!this.dom.filterProvince) return; // Clear existing options except the first one while (this.dom.filterProvince.options.length > 1) { this.dom.filterProvince.remove(1); } const fragment = document.createDocumentFragment(); this.state.provincesMap.forEach((name, key) => { const option = document.createElement('option'); option.value = key; option.textContent = name; fragment.appendChild(option); }); this.dom.filterProvince.appendChild(fragment); } // --- 5. FILTERING LOGIC --- initFilters() { if (!this.dom.filterForm) return; this._handlers.debouncedFilter = this.debounce(this.handleFilterChange, this.CONFIG.DEBOUNCE_DELAY); this.dom.filterForm.addEventListener('input', this._handlers.debouncedFilter); this.dom.filterForm.addEventListener('reset', this.handleFilterReset); this.dom.filterForm.addEventListener('submit', (e) => e.preventDefault()); } applyFiltersFromURL() { const params = new URLSearchParams(window.location.search); if (this.dom.filterKeyword) this.dom.filterKeyword.value = params.get('q') || ''; if (this.dom.filterProvince) this.dom.filterProvince.value = params.get('province') || ''; if (this.dom.filterAvailability) this.dom.filterAvailability.value = params.get('availability') || ''; if (this.dom.filterFeatured) this.dom.filterFeatured.checked = params.get('featured') === 'true'; // safe: only call applyFiltersFromForm if filterForm exists if (this.dom.filterForm) { this.applyFiltersFromForm(); } else { // fallback: use allProfiles this.state.filteredProfiles = Array.isArray(this.state.allProfiles) ? this.state.allProfiles.slice() : []; this.render(); } } applyFiltersFromForm() { if (!this.dom.filterForm) { this.state.filteredProfiles = Array.isArray(this.state.allProfiles) ? this.state.allProfiles.slice() : []; this.render(); return; } const params = new URLSearchParams(new FormData(this.dom.filterForm)); const keyword = params.get('q')?.toLowerCase().trim() ?? ''; const province = params.get('province') ?? ''; const availability = params.get('availability') ?? ''; const featured = params.get('featured') === 'true'; this.state.filteredProfiles = this.state.allProfiles.filter(p => (!keyword || (p.searchable && p.searchable.includes(keyword))) && (!province || p.provinceKey === province) && (!availability || p.availability === availability) && (!featured || p.isfeatured) ); const newUrl = `${window.location.pathname}?${params.toString()}`; window.history.replaceState({ path: newUrl }, '', newUrl); this.render(); } // --- 6. PROFESSIONAL-GRADE LIGHTBOX LOGIC --- initLightbox() { if (!this.dom.lightbox || !this.dom.body) return; // Use event delegation on the body for all lightbox-related clicks this.dom.body.addEventListener('click', this.handleLightboxInteraction); } openLightbox(triggerElement) { if (this.state.isLightboxOpen) return; if (!triggerElement) return; const rawId = triggerElement.dataset.profileId; const profileId = parseInt(rawId, 10); const profileData = this.getProfileById(profileId); if (!profileData) return; this.state.isLightboxOpen = true; this.state.lastFocusedElement = triggerElement; this.state.currentLightboxProfileId = profileId; if (this.dom.lightbox) { this.dom.lightbox.classList.remove('hidden'); this.dom.lightbox.setAttribute('aria-hidden', 'false'); } if (this.dom.body) this.dom.body.style.overflow = 'hidden'; this.populateLightbox(profileData, 0); if (this.state.gsap && this.dom.lightboxContentWrapper) { this.state.gsap.to(this.dom.lightboxContentWrapper, { scale: 1, opacity: 1, duration: 0.4, ease: 'power3.out' }); } setTimeout(() => this.dom.closeLightboxBtn?.focus(), 50); } closeLightbox() { if (!this.state.isLightboxOpen) return; this.state.isLightboxOpen = false; const onComplete = () => { if (this.dom.lightbox) { this.dom.lightbox.classList.add('hidden'); this.dom.lightbox.setAttribute('aria-hidden', 'true'); } if (this.dom.body) this.dom.body.style.overflow = ''; if (this.state.lastFocusedElement instanceof HTMLElement) { this.state.lastFocusedElement.focus(); } this.state.currentLightboxProfileId = null; }; if (this.state.gsap && this.dom.lightboxContentWrapper) { this.state.gsap.to(this.dom.lightboxContentWrapper, { scale: 0.95, opacity: 0, duration: 0.3, ease: 'power2.in', onComplete }); } else { onComplete(); } } populateLightbox(profileData, imageIndex = 0) { if (!profileData) return; if (this.dom.lightboxSpinner) this.dom.lightboxSpinner.classList.remove('hidden'); if (this.dom.lightboxImageError) this.dom.lightboxImageError.classList.add('hidden'); const heroImgEl = this.dom.lightboxHeroImage; if (heroImgEl) { heroImgEl.style.opacity = '0'; heroImgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; } const { name, images, quote, styleTags, description, lineId, altText, provinceKey, ...details } = profileData; if (this.dom.lightboxHeaderTitle) this.dom.lightboxHeaderTitle.textContent = `โปรไฟล์: ${name}`; if (this.dom.lightboxProfileName) this.dom.lightboxProfileName.textContent = name; if (this.dom.lightboxQuote) { this.dom.lightboxQuote.style.display = quote ? 'block' : 'none'; this.dom.lightboxQuote.textContent = quote ? `"${quote}"` : ''; } if (this.dom.lightboxDescription) this.dom.lightboxDescription.innerHTML = description ? description.replace(/\n/g, '<br>') : 'ไม่มีรายละเอียด'; if (this.dom.lightboxLineLink) this.dom.lightboxLineLink.href = lineId ? (lineId.startsWith('http') ? lineId : `https://line.me/ti/p/${lineId}`) : '#'; if (this.dom.lightboxLineLinkText) this.dom.lightboxLineLinkText.textContent = `ติดต่อ ${name} ผ่าน LINE`; this.populateTags(styleTags); this.populateDetails(details, provinceKey); const imageUrl = images && images.length > imageIndex ? images[imageIndex] : null; if (imageUrl && heroImgEl) { const imageLoader = new Image(); imageLoader.src = `${imageUrl}?width=1200&quality=85`; imageLoader.alt = altText || `รูปของ ${name}`; imageLoader.onload = () => { if (this.dom.lightboxSpinner) this.dom.lightboxSpinner.classList.add('hidden'); heroImgEl.src = imageLoader.src; heroImgEl.alt = imageLoader.alt; if (this.state.gsap) this.state.gsap.to(heroImgEl, { opacity: 1, duration: 0.4 }); else heroImgEl.style.opacity = '1'; }; imageLoader.onerror = () => { if (this.dom.lightboxSpinner) this.dom.lightboxSpinner.classList.add('hidden'); if (this.dom.lightboxImageError) this.dom.lightboxImageError.classList.remove('hidden'); }; } else { if (this.dom.lightboxSpinner) this.dom.lightboxSpinner.classList.add('hidden'); if (this.dom.lightboxImageError) this.dom.lightboxImageError.classList.remove('hidden'); } this.populateThumbnails(images, name, imageIndex); this.updateLightboxNav(); } populateTags(tags) { if (!this.dom.lightboxTags) return; this.dom.lightboxTags.innerHTML = (tags && tags.length > 0) ? tags.map(tag => `<span class="tag-item">${tag}</span>`).join('') : ''; } populateDetails(details, provinceKey) { if (!this.dom.lightboxDetails) return; const { age, stats, height, weight, skinTone, rate } = details; this.dom.lightboxDetails.innerHTML = ` <div class="stat-item"><div class="label">อายุ</div><div class="value">${age || '-'}</div></div> <div class="stat-item"><div class="label">สัดส่วน</div><div class="value">${stats || '-'}</div></div> <div class="stat-item"><div class="label">สูง/หนัก</div><div class="value">${height||'-'}/${weight||'-'}</div></div> <div class="stat-item"><div class="label">ผิว</div><div class="value">${skinTone || '-'}</div></div> <div class="stat-item"><div class="label">จังหวัด</div><div class="value">${this.state.provincesMap.get(provinceKey) || '-'}</div></div> <div class="stat-item"><div class="label">เรท</div><div class="value">${rate || 'สอบถาม'}</div></div> `; } populateThumbnails(images, name, activeIndex) { if (!this.dom.lightboxThumbnailStrip) return; this.dom.lightboxThumbnailStrip.innerHTML = ''; if (!images || images.length <= 1) return; this.dom.lightboxThumbnailStrip.innerHTML = images.map((img, index) => ` <button class="thumbnail-button ${index === activeIndex ? 'active' : ''}" role="tab" aria-selected="${index === activeIndex}" data-index="${index}" aria-label="รูปที่ ${index + 1}"> <img src="${img}?width=100&height=100&fit=cover&quality=75" alt="รูปย่อที่ ${index + 1} ของ ${name}"> </button> `).join(''); } updateLightboxNav() { const currentIndex = this.state.filteredProfiles.findIndex(p => String(p.id) === String(this.state.currentLightboxProfileId)); const total = (this.state.filteredProfiles || []).length; if (this.dom.lightboxPrevBtn) this.dom.lightboxPrevBtn.disabled = currentIndex <= 0; if (this.dom.lightboxNextBtn) this.dom.lightboxNextBtn.disabled = currentIndex >= total - 1; } navigateLightbox(direction) { const currentIndex = this.state.filteredProfiles.findIndex(p => String(p.id) === String(this.state.currentLightboxProfileId)); const nextIndex = currentIndex + direction; if (nextIndex >= 0 && nextIndex < (this.state.filteredProfiles || []).length) { const nextProfile = this.state.filteredProfiles[nextIndex]; this.state.currentLightboxProfileId = nextProfile.id; this.populateLightbox(nextProfile, 0); } } // --- 7. EVENT HANDLERS --- handleGlobalKeydown(event) { if (event.key === 'Escape') { if (this.state.isLightboxOpen) this.closeLightbox(); if (this.state.isMenuOpen) this.closeMobileMenu(); } if (this.state.isLightboxOpen) { if (event.key === 'ArrowRight' && this.dom.lightboxNextBtn && !this.dom.lightboxNextBtn.disabled) this.dom.lightboxNextBtn.click(); if (event.key === 'ArrowLeft' && this.dom.lightboxPrevBtn && !this.dom.lightboxPrevBtn.disabled) this.dom.lightboxPrevBtn.click(); } } handleLightboxInteraction(event) { // prioritise card click const cardTrigger = event.target.closest('.profile-card-new'); if (cardTrigger) { event.preventDefault(); this.openLightbox(cardTrigger); return; } // close by clicking backdrop/lightbox close if (this.dom.lightbox && (event.target === this.dom.lightbox || event.target.closest && event.target.closest('#closeLightboxBtn'))) { this.closeLightbox(); return; } // prev/next if (event.target.closest && event.target.closest('#lightbox-prev-btn')) { this.navigateLightbox(-1); return; } if (event.target.closest && event.target.closest('#lightbox-next-btn')) { this.navigateLightbox(1); return; } // thumbnail click const thumb = event.target.closest && event.target.closest('.thumbnail-button'); if (thumb) { const profile = this.getProfileById(this.state.currentLightboxProfileId); if (profile) this.populateLightbox(profile, parseInt(thumb.dataset.index, 10)); } } handleMobileMenuInteraction() { this.state.isMenuOpen ? this.closeMobileMenu() : this.openMobileMenu(); } handleFilterChange() { this.applyFiltersFromForm(); } handleFilterReset(e) { e.preventDefault(); if (this.dom.filterForm) { this.dom.filterForm.reset(); this.applyFiltersFromForm(); } } handleViewMore(event) { const button = event.currentTarget; const provinceKey = button.dataset.province; const allProvinceProfiles = (this.state.filteredProfiles || []).filter(p => p.provinceKey === provinceKey && !p.isfeatured); const grid = document.querySelector(`[data-province-grid="${provinceKey}"]`); if (grid) { const fragment = document.createDocumentFragment(); allProvinceProfiles.slice(this.CONFIG.PROFILES_PER_PROVINCE_ON_INDEX).forEach(p => fragment.appendChild(this.createCardHTML(p))); grid.appendChild(fragment); if (button.parentElement) button.parentElement.remove(); this.initScrollAnimations(grid); } } // --- 8. UTILITIES & MISC UI COMPONENTS --- debounce(func, delay) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; } initThemeToggle() { const btn = document.querySelector('.theme-toggle-btn'); if (!btn) return; const applyTheme = (theme) => document.documentElement.classList.toggle('dark', theme === 'dark'); const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); applyTheme(savedTheme); btn.addEventListener('click', () => { const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; applyTheme(newTheme); localStorage.setItem('theme', newTheme); }); } openMobileMenu() { if (this.state.isMenuOpen || !this.dom.sidebar) return; this.state.isMenuOpen = true; this.state.lastFocusedElement = document.activeElement; this.dom.sidebar.classList.remove('translate-x-full'); if (this.dom.backdrop) this.dom.backdrop.classList.remove('hidden'); if (this.dom.body) this.dom.body.style.overflow = 'hidden'; if (this.state.gsap && this.dom.backdrop) this.state.gsap.to(this.dom.backdrop, { opacity: 1, duration: 0.3 }); setTimeout(() => this.dom.closeSidebarBtn?.focus(), 50); if (this.dom.sidebar) this.dom.sidebar.setAttribute('aria-hidden', 'false'); } closeMobileMenu() { if (!this.state.isMenuOpen || !this.dom.sidebar) return; this.state.isMenuOpen = false; this.dom.sidebar.classList.add('translate-x-full'); if (this.dom.body) this.dom.body.style.overflow = ''; const onComplete = () => { if (this.dom.backdrop) this.dom.backdrop.classList.add('hidden'); }; if (this.state.gsap && this.dom.backdrop) { this.state.gsap.to(this.dom.backdrop, { opacity: 0, duration: 0.3, onComplete }); } else { onComplete(); } if (this.state.lastFocusedElement instanceof HTMLElement) this.state.lastFocusedElement.focus(); if (this.dom.sidebar) this.dom.sidebar.setAttribute('aria-hidden', 'true'); } initHeaderScrollEffect() { if (!this.dom.pageHeader) return; window.addEventListener('scroll', () => { this.dom.pageHeader.classList.toggle('scrolled', window.scrollY > 20); }, { passive: true }); } initBackToTop() { if (!this.dom.backToTopBtn) return; window.addEventListener('scroll', () => { const shouldBeVisible = window.scrollY > 400; this.dom.backToTopBtn.classList.toggle('opacity-100', shouldBeVisible); // แก้ไขบรรทัดนี้แล้ว this.dom.backToTopBtn.classList.toggle('pointer-events-auto', shouldBeVisible); }, { passive: true }); this.dom.backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); } async initAgeVerification() { if (!this.dom.ageVerificationOverlay || this.state.isAgeVerified) return; return new Promise(resolve => { this.dom.ageVerificationOverlay.classList.remove('hidden'); const close = (verified) => { if (verified) { sessionStorage.setItem('ageVerified', 'true'); this.state.isAgeVerified = true; this.dom.ageVerificationOverlay.classList.add('hidden'); resolve(); } else { // Go back or to a "safe" page window.location.href = 'https://www.google.com'; } }; if (this.dom.confirmAgeButton) this.dom.confirmAgeButton.onclick = () => close(true); if (this.dom.cancelAgeButton) this.dom.cancelAgeButton.onclick = () => close(false); }); } initScrollAnimations(context = document) { if (!this.state.gsap) return; const targets = context.querySelectorAll('.profile-card-new, .province-section-header'); this.state.gsap.from(targets, { opacity: 0, y: 30, duration: 0.7, stagger: 0.08, ease: 'power3.out', scrollTrigger: { trigger: context === document ? 'body' : context, start: 'top 85%', toggleActions: 'play none none none', }, }); } init3DCardEffect() { if (!this.state.gsap || !this.dom.body) return; this.dom.body.addEventListener('mousemove', e => { const card = e.target.closest('.profile-card-new'); if (card) { const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const { width, height } = rect; const rotateX = (y / height - 0.5) * -20; const rotateY = (x / width - 0.5) * 20; this.state.gsap.to(card, { rotationX: rotateX, rotationY: rotateY, scale: 1.05, duration: 0.7, ease: 'power3.out' }); } }); this.dom.body.addEventListener('mouseleave', () => { this.state.gsap.to('.profile-card-new', { rotationX: 0, rotationY: 0, scale: 1, duration: 1, ease: 'elastic.out(1, 0.5)' }); }); } // --- วางทับฟังก์ชัน generateFullSchema() เดิมในไฟล์ main.js --- generateFullSchema() { try { const pageTitle = document.title; const canonicalUrl = document.querySelector("link[rel='canonical']")?.href || window.location.href; const siteUrl = "https://sidelinechiangmai.netlify.app/"; // ใช้ URL หลักที่แน่นอน const orgName = "Sideline Chiangmai - รับงาน ไซด์ไลน์เชียงใหม่ ฟีลแฟน ตรงปก"; const mainSchema = { "@context": "https://schema.org", "@graph": [ { "@type": "Organization", "@id": `${siteUrl}#organization`, "name": orgName, "url": siteUrl, "logo": { "@type": "ImageObject", "url": `${siteUrl}images/logo-sideline-chiangmai.webp`, "width": 164, "height": 40 }, "contactPoint": { "@type": "ContactPoint", "contactType": "customer support", "url": "https://line.me/ti/p/_faNcjQ3xx" } }, { "@type": "WebSite", "@id": `${siteUrl}#website`, "url": siteUrl, "name": orgName, "description": "รวมโปรไฟล์ไซด์ไลน์เชียงใหม่, ลำปาง, เชียงราย คุณภาพ บริการฟีลแฟน การันตีตรงปก 100% ปลอดภัย ไม่ต้องมัดจำ", "publisher": { "@id": `${siteUrl}#organization` }, "inLanguage": "th-TH" }, { "@type": "WebPage", "@id": `${canonicalUrl}#webpage`, "url": canonicalUrl, "name": pageTitle, "isPartOf": { "@id": `${siteUrl}#website` }, "primaryImageOfPage": { "@type": "ImageObject", "url": `${siteUrl}images/sideline-chiangmai-social-preview.webp` }, "breadcrumb": { "@id": `${canonicalUrl}#breadcrumb` } }, { "@type": "LocalBusiness", "@id": `${siteUrl}#localbusiness`, "name": "SidelineChiangmai - ไซด์ไลน์เชียงใหม่ ฟีลแฟน ตรงปก", "image": `${siteUrl}images/sideline-chiangmai-social-preview.webp`, "url": siteUrl, "priceRange": "฿฿", "address": { "@type": "PostalAddress", "streetAddress": "เจ็ดยอด", "addressLocality": "ช้างเผือก", "addressRegion": "เชียงใหม่", "postalCode": "50300", "addressCountry": "TH" }, "geo": { "@type": "GeoCoordinates", "latitude": "18.814361", "longitude": "98.972389" }, "hasMap": "https://maps.app.goo.gl/3y8gyAtamm8YSagi9", "openingHours": ["Mo-Su 00:00-24:00"], "areaServed": [ { "@type": "City", "name": "Chiang Mai" }, { "@type": "City", "name": "Bangkok" }, { "@type": "City", "name": "Lampang" }, { "@type": "City", "name": "Chiang Rai" }, { "@type": "City", "name": "Pattaya" }, { "@type": "City", "name": "Phuket" } ] }, { "@type": "BreadcrumbList", "@id": `${canonicalUrl}#breadcrumb`, "itemListElement": [ { "@type": "ListItem", "position": 1, "name": "หน้าแรก", "item": siteUrl } ] }, { "@type": "FAQPage", "@id": `${siteUrl}#faq`, "mainEntity": [ { "@type": "Question", "name": "บริการไซด์ไลน์เชียงใหม่ ปลอดภัยและเป็นความลับหรือไม่?", "acceptedAnswer": { "@type": "Answer", "text": "Sideline Chiang Mai ให้ความสำคัญสูงสุดกับความปลอดภัยและความเป็นส่วนตัวของลูกค้าทุกท่าน ข้อมูลการติดต่อและการจองของท่านจะถูกเก็บรักษาเป็นความลับอย่างเข้มงวด" } }, { "@type": "Question", "name": "จำเป็นต้องโอนเงินมัดจำก่อนใช้บริการไซด์ไลน์หรือไม่?", "acceptedAnswer": { "@type": "Answer", "text": "เพื่อความสบายใจของลูกค้าทุกท่าน ท่านไม่จำเป็นต้องโอนเงินมัดจำใดๆ ทั้งสิ้น สามารถชำระค่าบริการเต็มจำนวนโดยตรงกับน้องๆ ที่หน้างานได้เลย" } }, { "@type": "Question", "name": "น้องๆ ไซด์ไลน์เชียงใหม่ตรงปกตามรูปที่แสดงในโปรไฟล์จริงหรือ?", "acceptedAnswer": { "@type": "Answer", "text": "เราคัดกรองและยืนยันตัวตนพร้อมรูปภาพของน้องๆ ทุกคนอย่างละเอียด Sideline Chiang Mai กล้าการันตีว่าน้องๆ ตรงปก 100% หากพบปัญหาใดๆ สามารถแจ้งทีมงานเพื่อดำเนินการแก้ไขได้ทันที" } } ] } ] }; // ตรวจหาและลบ Schema เก่าออกก่อน เพื่อป้องกันข้อมูลซ้ำซ้อน const oldSchemaTag = document.querySelector('script[type="application/ld+json"]'); if (oldSchemaTag) { oldSchemaTag.remove(); } // สร้างและใส่ Schema ใหม่เข้าไปใน <head> const schemaTag = document.createElement('script'); schemaTag.type = 'application/ld+json'; schemaTag.textContent = JSON.stringify(mainSchema, null, 2); // เพิ่ม null, 2 เพื่อให้อ่านง่ายขึ้นตอน debug document.head.appendChild(schemaTag); } catch (e) { console.warn("Failed to generate or update JSON-LD schema.", e); } } // end generateFullSchema() } // end class SidelineWebApp // instantiate try { new SidelineWebApp(); } catch (err) { console.error('Failed to start SidelineWebApp:', err); } })();