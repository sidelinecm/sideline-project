import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';

// ==========================================
// 1. CONFIGURATION
// ==========================================
const CONFIG = {
    SUPABASE_URL: 'https://zxetzqwjaiumqhrpumln.supabase.co',
    SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZXR6cXdqYWl1bXFocnB1bWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTMzMTIsImV4cCI6MjA4NzE4OTMxMn0.ZNJq1fF51rlKnfvIw-AZ65R1OpCmgA3-CkE2OtxpaX4',
    DOMAIN: 'https://sidelinechiangmai.netlify.app',
    BRAND_NAME: 'Sideline Chiang Mai (‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà)',
    SOCIAL_PROFILES: [
        "https://linktr.ee/sidelinechiangmai",
        "https://x.com/Sdl_chiangmai",
        "https://line.me/ti/p/ksLUMz3p_o"
    ]
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥ (Spintax) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ Google
const spin = (arr) => arr[Math.floor(Math.random() * arr.length)];

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö Hybrid (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Cloudinary ‡πÅ‡∏•‡∏∞ Supabase Storage)
const optimizeImg = (path) => {
    if (!path) return `${CONFIG.DOMAIN}/images/default.webp`;
    if (path.startsWith('http')) return path; // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Cloudinary ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
    return `${CONFIG.SUPABASE_URL}/storage/v1/object/public/profile-images/${path}`; // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Supabase
};

export default async (request, context) => {
    const ua = (request.headers.get('User-Agent') || '').toLowerCase();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Bot ‡∏´‡∏£‡∏∑‡∏≠ Social Media Crawler ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isBot = /bot|google|spider|crawler|facebook|twitter|line|whatsapp|telegram|discord|curl|wget|inspectiontool|lighthouse|headless/i.test(ua);
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Bot ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Client-side Rendering ‡∏õ‡∏Å‡∏ï‡∏¥
    if (!isBot) return context.next();

    try {
        const url = new URL(request.url);
        const pathParts = url.pathname.split('/').filter(Boolean);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö /sideline/{slug}
        if (pathParts[0] !== 'sideline' || pathParts.length < 2) return context.next();
        
        const slug = decodeURIComponent(pathParts[pathParts.length - 1]);
        
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô slug ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö
        if (['province', 'category', 'search', 'app'].includes(slug)) return context.next();

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
        const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ô
        const { data: p } = await supabase
            .from('profiles')
            .select('*, provinces(nameThai, key)')
            .eq('slug', slug)
            .eq('active', true)
            .maybeSingle();

        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 404 ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
        if (!p) return context.next();

        // ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (Related Profiles)
        let related = [];
        if (p.provinceKey) {
            const { data: relatedData } = await supabase
                .from('profiles')
                .select('slug, name, imagePath, location')
                .eq('provinceKey', p.provinceKey)
                .eq('active', true)
                .neq('id', p.id) 
                .limit(4);
            related = relatedData || [];
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const displayName = p.name || '‡∏™‡∏≤‡∏ß‡∏™‡∏ß‡∏¢';
        const provinceName = p.provinces?.nameThai || p.location || '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà';
        const provinceKey = p.provinces?.key || 'chiangmai';
        const displayPrice = parseInt(p.rate || "1500").toLocaleString() + ".-";
        const imageUrl = optimizeImg(p.imagePath);
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå LINE (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á ID ‡πÅ‡∏•‡∏∞ URL)
        let finalLineUrl = p.lineId || 'ksLUMz3p_o';
        if (!finalLineUrl.startsWith('http')) {
            finalLineUrl = `https://line.me/ti/p/~${finalLineUrl}`;
        }

        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á Rating ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Google ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Rich Snippets (‡∏î‡∏≤‡∏ß)
        const charCodeSum = slug.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const ratingValue = (4.7 + (charCodeSum % 4) / 10).toFixed(1);
        const reviewCount = 150 + (charCodeSum % 100);

        // SEO Spintax
        const titleIntro = spin(["‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡∏£‡∏µ‡∏ß‡∏¥‡∏ß", "‡∏û‡∏ö‡∏Å‡∏±‡∏ö", "‡∏°‡∏≤‡πÅ‡∏£‡∏á", "‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏•‡∏≤‡∏î"]);
        const serviceWord = spin(["‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏¥‡∏ß‡πÅ‡∏ü‡∏ô", "‡πÄ‡∏≠‡∏≤‡πÉ‡∏à‡πÄ‡∏Å‡πà‡∏á", "‡∏á‡∏≤‡∏ô‡∏î‡∏µ‡∏ï‡∏£‡∏á‡∏õ‡∏Å", "‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á", "‡∏Ç‡∏µ‡πâ‡∏≠‡πâ‡∏≠‡∏ô"]);
        const payWord = spin(["‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥", "‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "‡πÄ‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡πà‡∏≤‡∏¢", "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 100%"]);
        
        const pageTitle = `${titleIntro} ${displayName} - ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName} ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á ‡∏ü‡∏¥‡∏ß‡πÅ‡∏ü‡∏ô ‡∏£‡∏π‡∏õ‡∏ï‡∏£‡∏á‡∏õ‡∏Å 100%`;
        const metaDesc = `${displayName} ‡∏™‡∏≤‡∏ß‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName} ‡∏≠‡∏≤‡∏¢‡∏∏ ${p.age || '20+'}‡∏õ‡∏µ ${serviceWord} ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡πÄ‡∏¢‡πà‡∏ô‡∏ï‡πå ${payWord} ‡∏£‡∏π‡∏õ‡∏ï‡∏£‡∏á‡∏õ‡∏Å ‡∏û‡∏¥‡∏Å‡∏±‡∏î${p.location || provinceName} ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡∏Å‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏•‡∏¢!`;
        const canonicalUrl = `${CONFIG.DOMAIN}/sideline/${slug}`;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Schema Markup (JSON-LD)
        const schemaData = {
            "@context": "https://schema.org/",
            "@graph": [
                {
                    "@type": ["Organization", "LocalBusiness"],
                    "@id": `${CONFIG.DOMAIN}/#organization`,
                    "name": CONFIG.BRAND_NAME,
                    "url": CONFIG.DOMAIN,
                    "image": [imageUrl],
                    "address": {
                        "@type": "PostalAddress",
                        "addressLocality": provinceName,
                        "addressCountry": "TH"
                    },
                    "sameAs": CONFIG.SOCIAL_PROFILES
                },
                {
                    "@type": "BreadcrumbList",
                    "itemListElement": [
                        { "@type": "ListItem", "position": 1, "name": "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", "item": CONFIG.DOMAIN },
                        { "@type": "ListItem", "position": 2, "name": `‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName}`, "item": `${CONFIG.DOMAIN}/location/${provinceKey}` },
                        { "@type": "ListItem", "position": 3, "name": displayName, "item": canonicalUrl }
                    ]
                },
                {
                    "@type": "Product",
                    "@id": `${canonicalUrl}#product`,
                    "name": pageTitle,
                    "image": [imageUrl],
                    "description": metaDesc,
                    "brand": { "@type": "Brand", "name": CONFIG.BRAND_NAME },
                    "offers": {
                        "@type": "Offer",
                        "price": (p.rate || "1500").toString().replace(/[^0-9]/g, ''),
                        "priceCurrency": "THB",
                        "availability": "https://schema.org/InStock",
                        "url": canonicalUrl
                    },
                    "aggregateRating": {
                        "@type": "AggregateRating",
                        "ratingValue": ratingValue,
                        "reviewCount": reviewCount.toString()
                    }
                }
            ]
        };

        // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML (Full Version)
        const html = `<!DOCTYPE html>
<html lang="th" prefix="og: https://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${pageTitle}</title>
    <meta name="description" content="${metaDesc}">
    <link rel="canonical" href="${canonicalUrl}">
    <meta name="robots" content="index, follow, max-image-preview:large">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:locale" content="th_TH">
    <meta property="og:title" content="${pageTitle}">
    <meta property="og:description" content="${metaDesc}">
    <meta property="og:image" content="${imageUrl}">
    <meta property="og:url" content="${canonicalUrl}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="${CONFIG.BRAND_NAME}">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="${pageTitle}">
    <meta name="twitter:description" content="${metaDesc}">
    <meta name="twitter:image" content="${imageUrl}">

    <!-- Schema Markup -->
    <script type="application/ld+json">${JSON.stringify(schemaData)}</script>
    
    <style>
        :root { --primary: #db2777; --success: #06c755; --dark: #1f2937; --light: #f3f4f6; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #fff; color: var(--dark); line-height: 1.6; }
        .container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; border-left: 1px solid var(--light); border-right: 1px solid var(--light); }
        .hero-img { width: 100%; height: auto; display: block; aspect-ratio: 3/4; object-fit: cover; background: var(--light); }
        .content { padding: 24px; }
        .rating-box { display: flex; align-items: center; gap: 4px; color: #fbbf24; font-weight: 700; font-size: 15px; margin-bottom: 8px; }
        h1 { color: var(--primary); font-size: 24px; margin: 0 0 16px 0; font-weight: 800; line-height: 1.2; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .info-item { border: 1px solid var(--light); border-radius: 16px; padding: 16px; background: #f9fafb; }
        .info-item b { display: block; font-size: 11px; color: #9ca3af; text-transform: uppercase; margin-bottom: 4px; }
        .info-item span { font-size: 16px; font-weight: 700; color: #111827; }
        .description { font-size: 15px; color: #4b5563; margin-bottom: 24px; white-space: pre-line; }
        .btn-line { display: flex; align-items: center; justify-content: center; background: var(--success); color: #fff; padding: 18px; border-radius: 100px; text-decoration: none; font-weight: 700; font-size: 18px; box-shadow: 0 10px 15px -3px rgba(6,199,85,.4); margin-bottom: 30px; }
        .related-title { font-weight: 800; color: var(--primary); display: block; margin-bottom: 15px; font-size: 18px; border-top: 1px solid var(--light); pt: 20px; }
        .related-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .related-card { text-decoration: none; color: inherit; display: block; }
        .related-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; background: #eee; }
        .related-card-name { font-weight: 700; margin-top: 8px; font-size: 14px; color: var(--dark); }
        .footer { text-align: center; font-size: 12px; color: #9ca3af; margin-top: 40px; padding: 20px; border-top: 1px solid var(--light); }
    </style>
</head>
<body>
    <div class="container">
        <img src="${imageUrl}" class="hero-img" alt="${displayName} ${provinceName}">
        <div class="content">
            <div class="rating-box">‚≠ê ${ratingValue} <span>(${reviewCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span></div>
            <h1>${pageTitle}</h1>
            <div class="info-grid">
                <div class="info-item"><b>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</b><span>${displayPrice}</span></div>
                <div class="info-item"><b>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</b><span>${p.location || provinceName}</span></div>
            </div>
            <div class="description">
                ${p.description || metaDesc}
            </div>
            <a href="${finalLineUrl}" class="btn-line">üì≤ ‡∏ó‡∏±‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß ${displayName}</a>

            ${related.length > 0 ? `
            <span class="related-title">üî• ‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô${provinceName}:</span>
            <div class="related-grid">
                ${related.map(r => `
                    <a href="${CONFIG.DOMAIN}/sideline/${r.slug}" class="related-card">
                        <img src="${optimizeImg(r.imagePath)}" alt="${r.name}">
                        <div class="related-card-name">${r.name}</div>
                        <div style="font-size:12px; color:#9ca3af; margin-top:2px;">üìç ${r.location || provinceName}</div>
                    </a>
                `).join('')}
            </div>` : ''}
            
            <div class="footer">
                ¬© ${new Date().getFullYear()} ${CONFIG.BRAND_NAME} - ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
            </div>
        </div>
    </div>
</body>
</html>`;

        return new Response(html, { 
            headers: { 
                "content-type": "text/html; charset=utf-8",
                "x-robots-tag": "index, follow",
                "Cache-Control": "public, s-maxage=86400"
            } 
        });

    } catch (e) {
        console.error("Render Bot Error:", e);
        return context.next();
    }
};