
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8'; export default async (request, context) => { const userAgent = request.headers.get('User-Agent') || ''; const isBot = /googlebot|bingbot|yandexbot|duckduckbot|slurp|baiduspider|twitterbot|facebookexternalhit|discordbot|linkedinbot|whatsapp|line/i.test(userAgent); if (!isBot) return context.next(); try { const url = new URL(request.url); const pathSegments = url.pathname.split('/').filter(Boolean); const rawSlug = pathSegments[pathSegments.length - 1]; if (!rawSlug) return context.next(); const profileSlug = decodeURIComponent(rawSlug); // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å URL const SUPABASE_URL = 'https://hgzbgpbmymoiwjpaypvl.supabase.co'; const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnemJncGJteW1vaXdqcGF5cHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxMDUyMDYsImV4cCI6MjA2MjY4MTIwNn0.dIzyENU-kpVD97WyhJVZF9owDVotbl1wcYgPTt9JL_8'; const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î const { data: profile } = await supabase.from('profiles').select('*, provinces(nameThai)').eq('slug', profileSlug).maybeSingle(); if (!profile) return context.next(); const provinceName = profile.provinces?.nameThai || '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà'; const imageUrl = profile.imagePath ? `${SUPABASE_URL}/storage/v1/object/public/profile-images/${profile.imagePath}` : `https://sidelinechiangmai.netlify.app/images/default_og_image.jpg`; const pageUrl = `https://sidelinechiangmai.netlify.app/sideline/${encodeURIComponent(profile.slug)}`; const numericPrice = profile.rate ? profile.rate.toString().replace(/[^0-9]/g, '') : "1500"; const html = `<!DOCTYPE html> <html lang="th"> <head> <meta charset="UTF-8"> <title>‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName} ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏õ‡∏Å | Sideline Chiangmai</title> <meta name="description" content="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô${provinceName} ‡∏≠‡∏≤‡∏¢‡∏∏ ${profile.age} ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ${profile.stats} ‡∏û‡∏¥‡∏Å‡∏±‡∏î ${profile.location} ‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡∏á‡∏≤‡∏ô‡∏î‡∏µ"> <link rel="canonical" href="${pageUrl}"> <meta property="og:title" content="‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName}"> <meta property="og:description" content="‡∏û‡∏¥‡∏Å‡∏±‡∏î ${profile.location} ‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤ ${profile.rate} ‡∏ö‡∏≤‡∏ó"> <meta property="og:image" content="${imageUrl}"> <meta property="og:type" content="profile"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Product", "name": "‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName}", "image": "${imageUrl}", "description": "‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô${provinceName} ‡∏û‡∏¥‡∏Å‡∏±‡∏î ${profile.location}", "offers": { "@type": "Offer", "price": "${numericPrice}", "priceCurrency": "THB", "availability": "https://schema.org/InStock" } } </script> <style>body{font-family:sans-serif;padding:20px;line-height:1.6}img{max-width:100%;height:auto;border-radius:10px}h1{color:#d53f8c}.btn{display:inline-block;background:#06c755;color:#fff;padding:10px 20px;border-radius:20px;text-decoration:none}</style> </head> <body> <article> <h1>‡∏ô‡πâ‡∏≠‡∏á ${profile.name} (${provinceName})</h1> <img src="${imageUrl}" alt="‡∏ô‡πâ‡∏≠‡∏á ${profile.name} ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå${provinceName} ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏õ‡∏Å"> <p><strong>‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${profile.rate} ‡∏ö‡∏≤‡∏ó</p> <p><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${profile.location}</p> <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${profile.description || '-'}</p> <a href="https://line.me/ti/p/${profile.lineId}" class="btn">üì≤ ‡πÅ‡∏≠‡∏î‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</a> </article> </body> </html>`; return new Response(html, { headers: { "Content-Type": "text/html; charset=utf-8" } }); } catch (e) { return context.next(); } }; 
