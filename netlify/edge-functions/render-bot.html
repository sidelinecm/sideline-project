import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';

export default async (request, context) => {
  const userAgent = request.headers.get('User-Agent') || '';
  const isBot = /googlebot|bingbot|yandexbot|duckduckbot|slurp|baiduspider|twitterbot|facebookexternalhit|discordbot|linkedinbot|whatsapp|line|applebot/i.test(userAgent);

  // ถ้าไม่ใช่ Bot ให้ผ่านไปเลย
  if (!isBot) return context.next();

  const url = new URL(request.url);

  // ✅ แก้ไขจุดที่ 1: เช็คก่อนว่า URL ใช่หน้าน้องรายบุคคลหรือไม่
  // สมมติว่าโครงสร้าง URL ของคุณคือ /sideline/ชื่อน้อง
  // ถ้า URL เป็น /chiangmai หรือ /location/chiangmai ให้ข้ามไปเลย เพื่อไม่ให้เกิด 404
  if (!url.pathname.startsWith('/sideline/')) {
    return context.next();
  }

  try {
    const pathSegments = url.pathname.split('/').filter(Boolean);
    const rawSlug = pathSegments[pathSegments.length - 1];

    if (!rawSlug) return context.next();

    const profileSlug = decodeURIComponent(rawSlug);
    const SUPABASE_URL = 'https://hgzbgpbmymoiwjpaypvl.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_KEY_HERE'; // (ใส่ Key เดิมของคุณ)

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ดึงข้อมูล
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*, provinces(nameThai, key)')
      .eq('slug', profileSlug)
      .maybeSingle();

    // ถ้า Database Error หรือหาไม่เจอ ให้ return next() เพื่อให้ Frontend จัดการ 404 เอง
    // หรือถ้ามั่นใจว่า Bot ควรเจอ 404 จริงๆ ค่อย return Response 404
    if (error || !profile) {
       // แนะนำ: ส่งต่อให้ Frontend จัดการดีกว่าเผื่อ Logic ผิดพลาดจะได้ไม่หน้าขาว
       return context.next(); 
    }

    // ... (ส่วนการสร้าง HTML เหมือนเดิม) ...
    // แนะนำ: ตรง imageUrl เช็คดีๆ ถ้าไม่มีรูป อย่าให้ Link เสีย

    const provinceName = profile.provinces?.nameThai || 'เชียงใหม่';
    // ... โค้ดส่วนสร้าง HTML ที่เหลือ ...
    
    // (copy ส่วน HTML เดิมมาใส่ต่อตรงนี้)
    // ...
    
    return new Response(html, { headers });

  } catch (e) {
    // ถ้า Error ให้ปล่อยผ่านไปหน้าเว็บปกติ อย่าให้เว็บล่ม
    console.error(e);
    return context.next();
  }
};
